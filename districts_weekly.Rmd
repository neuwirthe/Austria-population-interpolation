---
title: "Data for districts weekly"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
suppressPackageStartupMessages({
  library(tidyverse)
  library(fs)
  library(here)
  library(lubridate)
  library(readxl)
})
```

```{r}
source(path("utils","purl_and_source.R"))
```

```{r}
save_path <- path(here(),"r_data")
```

```{r}
if(!dir_exists(save_path)) dir_create(save_path)
```
```{r}
purl_and_source(path("utils/get_base_files.Rmd"))
```

```{r}
load(path(save_path,"pop_GKZ_age_1y_gender_yearly.RData"))
```

Yearly data for districts (Bezirke)

```{r}
pop_GKZ_age_1y_gender_yearly |>
  mutate(BKZ=floor(GKZ/100)) |>
  group_by(Jahr,BKZ,Alter,Geschlecht) |>
  summarise(pop=sum(pop)) |>
  ungroup() ->
  pop_BKZ_age_1y_gender_yearly
```

```{r}
pop_BKZ_age_1y_gender_yearly |>
  left_join(namen_bezirke |>
              select(BKZ,Name)) ->
  pop_BKZ_age_1y_gender_yearly
```

```{r}
save(pop_BKZ_age_1y_gender_yearly,
     file=path(here(),"r_data",
               "pop_BKZ_age_1y_gender_yearly.RData"))  
```



```{r}
paste(2002:2023,"12","31",sep="-") |>
  as.Date() |>
  keep(\(x)isoweek(x)==53) |>
  year() ->
  years_with_week_53
```



```{r}
expand_grid(
  Jahr= 2002:2022,
  Woche=1:52,
  BKZ = pop_BKZ_age_1y_gender_yearly |>
    pull(BKZ) |> unique(),
  Alter=pop_BKZ_age_1y_gender_yearly |>
    pull(Alter) |> unique(),
  Geschlecht=c("m","w")) |>
  mutate(Jahr_Woche=Jahr+(Woche-1)/52) |>
  arrange(Jahr,Woche,BKZ,Alter,Geschlecht,Jahr_Woche) ->
  interpolation_BKZ_input
```


```{r}
expand_grid(
  Jahr= 2002:2022,
  Woche=1:52,
  BKZ = pop_BKZ_age_1y_gender_yearly |>
    pull(BKZ) |> unique(),
  Alter=pop_BKZ_age_1y_gender_yearly |>
    pull(Alter) |> unique(),
  Geschlecht=c("m","w")) |>
  left_join(pop_BKZ_age_1y_gender_yearly) |>
  replace_na(list(pop=0)) |>
  mutate(pop=ifelse(Woche==1,pop,NA)) ->
  interpolation_BKZ_base
```



```{r}
interpolation_BKZ_input |>
  left_join(interpolation_BKZ_base # |>
) |>
  group_by(BKZ,Alter,Geschlecht) |>
  mutate(pop_new=approxfun(cur_data() |> 
                             filter(!is.na(pop)) |> 
                             pull(Jahr_Woche),
                           cur_data() |> 
                             filter(!is.na(pop)) |> 
                             pull(pop),
                           rule=2)(Jahr_Woche)
         ) |>
  ungroup() |>
  select(-pop) |>
  rename(pop=pop_new) |>
  select(Jahr,Woche,Jahr_Woche,everything()) |>
  select(-Jahr_Woche) ->
  pop_BKZ_age_1y_gender_weekly
```



```{r}
pop_BKZ_age_1y_gender_weekly |>
  bind_rows(
    pop_BKZ_age_1y_gender_weekly |>
    filter(Woche==1) |>
  mutate(Jahr=Jahr-1,
         Woche=53) |>
  filter(Jahr > min(Jahr)) |>
    filter(Jahr %in% years_with_week_53 |
             Woche < 53)
  ) |>
  arrange(Jahr,Woche,BKZ,Alter,Geschlecht) ->
pop_BKZ_age_1y_gender_weekly   
```




```{r}
date_year_week <-
  tibble(
    Datum =  
      seq(as.Date("2001-12-31"),as.Date("2023-01-06"),by="7 days")) |>
      mutate(Jahr=isoyear(Datum),
             Woche=isoweek(Datum))
    
```



```{r}
pop_BKZ_age_1y_gender_weekly |>
  left_join(date_year_week) |>
  select(Jahr,Woche,Datum,everything()) ->
pop_BKZ_age_1y_gender_weekly  
```



```{r}
pop_BKZ_age_1y_gender_weekly |>
  left_join(namen_bezirke |>
              select(BKZ,Name)) ->
  pop_BKZ_age_1y_gender_weekly
```



```{r}
save(pop_BKZ_age_1y_gender_weekly,
     file=path(save_path,
               "pop_BKZ_age_1y_gender_weekly.Rdata"))
```



```{r}
pop_BKZ_age_1y_gender_weekly |> 
  mutate(BundeslandID=floor(BKZ/100)) |>
  group_by(Jahr,Woche,Datum,BundeslandID,Alter,Geschlecht) |>
  summarise(pop=sum(pop)) |>
  ungroup() ->
  pop_bl_age_1y_gender_weekly   
```

```{r}
pop_bl_age_1y_gender_weekly |> 
  mutate(BundeslandID=10) |>
  group_by(Jahr,Woche,Datum,BundeslandID,Alter,Geschlecht) |>
  summarise(pop=sum(pop)) |>
  ungroup() ->
  pop_aut_age_1y_gender_weekly 
```

```{r}
pop_bl_age_1y_gender_weekly |>
  bind_rows(
  pop_aut_age_1y_gender_weekly 
  ) -> 
  pop_aut_bl_age_1y_gender_weekly  
```


```{r}
  pop_aut_bl_age_1y_gender_weekly  |>
  left_join(namen_bl) ->
  pop_aut_bl_age_1y_gender_weekly
```

```{r}
save(pop_aut_bl_age_1y_gender_weekly,
     file=path(save_path,
               "pop_aut_bl_age_1y_gender_weekly.Rdata"))
```

```{r}
pop_aut_bl_age_1y_gender_weekly |>
  group_by(Jahr,Woche,Datum,BundeslandID,Bundesland,Geschlecht) |>
  summarise(pop=sum(pop)) |>
  ungroup() ->
  pop_aut_bl_gender_weekly
```

```{r}
save(pop_aut_bl_gender_weekly,
     file=path(save_path,
               "pop_aut_bl_gender_weekly.Rdata"))
```


```{r}
pop_aut_bl_gender_weekly |>
  group_by(Jahr,Woche,Datum,BundeslandID,Bundesland) |>
  summarise(pop=sum(pop)) |>
  ungroup() ->
  pop_aut_bl_weekly
```


```{r}
save(pop_aut_bl_weekly,
     file=path(save_path,
               "pop_aut_bl_weekly.Rdata"))
```